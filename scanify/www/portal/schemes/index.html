{% extends "portal_base.html" %}

{% block title %}{{ _("Scheme Management") }}{% endblock %}

{% block portal_content %}
<div class="schemes-page">
    <div class="row mb-4">
        <div class="col-md-8">
            <h2><i class="fa fa-file-text"></i> Scheme Management</h2>
            <p class="text-muted">Create and manage scheme requests</p>
        </div>
        <div class="col-md-4 text-right">
            <a href="/portal/schemes/new" class="btn btn-primary">
                <i class="fa fa-plus"></i> New Scheme Request
            </a>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fa fa-filter"></i> Filters
        </div>
        <div class="card-body">
            <form id="scheme-filter-form">
                <div class="row">
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>Status</label>
                            <select class="form-control" name="status">
                                <option value="">All Status</option>
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                                <option value="Rejected">Rejected</option>
                                <option value="Rerouted">Rerouted</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>From Date</label>
                            <input type="date" class="form-control" name="from_date">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>To Date</label>
                            <input type="date" class="form-control" name="to_date">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-group">
                            <label>&nbsp;</label>
                            <button type="submit" class="btn btn-secondary btn-block">
                                <i class="fa fa-search"></i> Filter
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Schemes List -->
    <div class="card">
        <div class="card-header">
            <i class="fa fa-list"></i> Scheme Requests
        </div>
        <div class="card-body p-0">
            <div id="schemes-list">
                <div class="text-center p-5">
                    <i class="fa fa-spinner fa-spin fa-3x text-muted"></i>
                    <p class="mt-3 text-muted">Loading schemes...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    loadSchemes();

    $('#scheme-filter-form').on('submit', function(e) {
        e.preventDefault();
        loadSchemes();
    });
});

function loadSchemes() {
    $('#schemes-list').html(`
        <div class="text-center p-5">
            <i class="fa fa-spinner fa-spin fa-3x text-muted"></i>
            <p class="mt-3 text-muted">Loading schemes...</p>
        </div>
    `);

    let filters = {
        status: $('select[name="status"]').val(),
        from_date: $('input[name="from_date"]').val(),
        to_date: $('input[name="to_date"]').val()
    };

    frappe.call({
        method: 'scanify.api.get_user_schemes',
        args: { filters: JSON.stringify(filters) },
        callback: function(r) {
            if (r.message) {
                renderSchemes(r.message);
            }
        },
        error: function(r) {
            $('#schemes-list').html(`
                <div class="alert alert-danger m-3">
                    <i class="fa fa-exclamation-triangle"></i> Error loading schemes
                </div>
            `);
        }
    });
}

function renderSchemes(schemes) {
    let html = '';
    
    if (schemes.length === 0) {
        html = `<div class="alert alert-info m-3">
            <i class="fa fa-info-circle"></i> No schemes found
        </div>`;
    } else {
        html = `<div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                    <tr>
                        <th>Scheme ID</th>
                        <th>Date</th>
                        <th>Doctor</th>
                        <th>Stockist</th>
                        <th>HQ</th>
                        <th>Value</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>`;
        
        schemes.forEach(function(scheme) {
            let statusClass = {
                'Approved': 'success',
                'Pending': 'warning',
                'Rejected': 'danger',
                'Rerouted': 'info'
            }[scheme.approvalstatus] || 'secondary';

            html += `<tr>
                <td><strong>${scheme.name}</strong></td>
                <td>${frappe.datetime.str_to_user(scheme.applicationdate)}</td>
                <td>${scheme.doctorname || '-'}</td>
                <td>${scheme.stockistname || '-'}</td>
                <td>${scheme.hq || '-'}</td>
                <td>â‚¹ ${format_currency(scheme.totalschemevalue || 0)}</td>
                <td><span class="badge badge-${statusClass}">${scheme.approvalstatus}</span></td>
                <td>
                    <a href="/app/scheme-request/${scheme.name}" class="btn btn-sm btn-primary" target="_blank">
                        <i class="fa fa-eye"></i> View
                    </a>
                </td>
            </tr>`;
        });
        
        html += `</tbody></table></div>`;
    }
    
    $('#schemes-list').html(html);
}

function format_currency(value) {
    return new Intl.NumberFormat('en-IN', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    }).format(value);
}
</script>
{% endblock %}
