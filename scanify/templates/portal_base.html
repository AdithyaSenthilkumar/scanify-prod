<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}{% endblock %} - Stedman Portal</title>
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="/assets/scanify/css/portal.css">
    
    {% block head_include %}{% endblock %}
</head>
<body>
    <!-- Top Navigation Bar -->
    <nav class="topbar">
        <div class="topbar-container">
            <div class="topbar-brand">
                <a href="/portal" class="brand-link">
<div class="brand-logo">
    <img src="/assets/scanify/images/scanify_logo.jpg" alt="Scanify Logo">
</div>                    <span class="brand-name">Stedman Portal</span>
                </a>
            </div>
            
            <button class="menu-toggle" type="button" onclick="toggleSidebar()">
                <span class="toggle-icon"></span>
                <span class="toggle-icon"></span>
                <span class="toggle-icon"></span>
            </button>

            <div class="topbar-right">
            <!-- Division Switcher -->
                <div class="division-switcher">
                    <button class="division-button" type="button" id="divisionMenuButton" onclick="toggleDivisionMenu(event)">
                        <i class="fa fa-building"></i>
                        <span class="division-name">{{ division or "Prima" }}</span>
                        <i class="fa fa-chevron-down"></i>
                    </button>
                    <div class="dropdown-menu dropdown-menu-right" id="divisionDropdown">
                        <div class="dropdown-header"><strong>Switch Division</strong></div>
                        <a class="dropdown-item division-option" href="javascript:void(0)" onclick="switchDivision('Prima', event)">
                            <i class="fa fa-check" style="visibility: {{ 'visible' if division == 'Prima' else 'hidden' }}"></i>
                            Prima
                        </a>
                        <a class="dropdown-item division-option" href="javascript:void(0)" onclick="switchDivision('Vektra', event)">
                            <i class="fa fa-check" style="visibility: {{ 'visible' if division == 'Vektra' else 'hidden' }}"></i>
                            Vektra
                        </a>
                    </div>
                </div>

            <!-- User Menu (existing) -->
            <div class="user-menu">
                <button class="user-button" type="button" id="userMenuButton" data-toggle="dropdown">
                    <i class="fa fa-user-circle"></i>
                    <span class="user-name">{{ frappe.session.user }}</span>
                    <i class="fa fa-chevron-down"></i>
                </button>
                <div class="dropdown-menu dropdown-menu-right">
                    <div class="dropdown-header">
                        <div><strong>Division:</strong> {{ division or 'Prima' }}</div>
                        <div><strong>Role:</strong> {{ user_role or 'User' }}</div>
                    </div>
                    <div class="dropdown-divider"></div>
                    <a class="dropdown-item" href="/logout">
                        <i class="fa fa-sign-out-alt"></i> Logout
                    </a>
                </div>
            </div>
        </div>

        </div>
    </nav>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <nav class="sidebar-nav">
                <!-- Main Menu -->
                <div class="nav-section">
                    <div class="nav-section-title">Main Menu</div>
                    <a href="/portal" class="nav-link">
                        <i class="fa fa-home"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="/portal/schemes" class="nav-link">
                        <i class="fa fa-file-alt"></i>
                        <span>Schemes</span>
                    </a>
                    <a href="/portal/stock-statements" class="nav-link">
                        <i class="fa fa-database"></i>
                        <span>Stock Statements</span>
                    </a>
                </div>

                <!-- Masters -->
                <div class="nav-section">
                    <div class="nav-section-title">Masters</div>
                    <a href="/portal/masters" class="nav-link">
                        <i class="fa fa-database"></i> <span>All Masters</span>
                    </a>
                    <a href="/portal/doctors" class="nav-link">
                        <i class="fa fa-user-md"></i> <span>Doctors</span>
                    </a>
                    <a href="/portal/stockists" class="nav-link">
                        <i class="fa fa-building"></i> <span>Stockists</span>
                    </a>
                    <a href="/portal/products" class="nav-link">
                        <i class="fa fa-cubes"></i> <span>Products</span>
                    </a>
                    <a href="/portal/hqs" class="nav-link">
                        <i class="fa fa-map-marker-alt"></i> <span>HQs</span>
                    </a>
                </div>


                <!-- Reports -->
                <div class="nav-section">
                    <div class="nav-section-title">Reports</div>
                    <a href="/portal/reports/moving-trend" class="nav-link">
                        <i class="fa fa-chart-line"></i>
                        <span>Moving Trend</span>
                    </a>
                    <a href="/portal/reports/secondary-sales" class="nav-link">
                        <i class="fa fa-chart-bar"></i>
                        <span>Secondary Sales</span>
                    </a>
                    <a href="/portal/reports/ranking" class="nav-link">
                        <i class="fa fa-trophy"></i>
                        <span>Ranking</span>
                    </a>
                </div>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-inner">
                {% block portal_content %}{% endblock %}
            </div>

            <!-- Footer -->
            <footer class="footer">
                <div class="footer-content">
                    <span>&copy; 2026 Stedman Pharmaceuticals. All rights reserved.</span>
                    <span class="footer-divider">|</span>
                    <span>Powered by Scanify</span>
                </div>
            </footer>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
{{ include_script('frappe-web.bundle.js') }}

    <script>
    // Make frappe available
    window.frappe = window.frappe || {};
    frappe.datetime = frappe.datetime || {};
    frappe.datetime.str_to_user = function(dateStr) {
        if (!dateStr) return '';
        let date = new Date(dateStr);
        return date.toLocaleDateString('en-GB');
    };
    
    // Active link highlighting
    $(document).ready(function() {
        let currentPath = window.location.pathname;
        $('.nav-link').each(function() {
            let href = $(this).attr('href');
            if (currentPath === href || (href !== '/portal' && currentPath.startsWith(href))) {
                $(this).addClass('active');
            }
        });
    });

    // Toggle sidebar for mobile
    function toggleSidebar() {
        $('#sidebar').toggleClass('show');
    }

    // Close sidebar when clicking outside on mobile
    $(document).on('click', function(e) {
        if (window.innerWidth <= 768) {
            if (!$(e.target).closest('.sidebar, .menu-toggle').length) {
                $('#sidebar').removeClass('show');
            }
        }
    });

    // Division Switcher Functions
    function toggleDivisionMenu(event) {
        event.stopPropagation();
        $('#divisionDropdown').toggleClass('show');
    }

    // Close dropdown when clicking outside
    $(document).on('click', function(e) {
        if (!$(e.target).closest('.division-switcher').length) {
            $('#divisionDropdown').removeClass('show');
        }
    });

function getCSRFToken() {
    let name = "csrf_token=";
    let decodedCookie = decodeURIComponent(document.cookie);
    let ca = decodedCookie.split(';');
    for (let i = 0; i < ca.length; i++) {
        let c = ca[i].trim();
        if (c.indexOf(name) === 0) {
            return c.substring(name.length, c.length);
        }
    }
    return null;
}



function switchDivision(selectedDivision, event) {
    event.preventDefault();
    event.stopPropagation();

    let currentDivision = "{{ division }}";

    if (selectedDivision === currentDivision) {
        showAlert('Already viewing ' + selectedDivision + ' division', 'info');
        $('#divisionDropdown').removeClass('show');
        return;
    }

    showLoadingOverlay('Switching to ' + selectedDivision + ' division...');

    $.ajax({
        url: '/api/method/scanify.api.set_user_division',
        type: 'POST',
        contentType: 'application/json',
        headers: {
            'X-Frappe-CSRF-Token': getCSRFToken()
        },
        data: JSON.stringify({
            division: selectedDivision
        }),
        success: function (r) {
            hideLoadingOverlay();

            if (r.message && r.message.success) {
                showAlert('Switched to ' + selectedDivision + ' division', 'success');
                setTimeout(() => window.location.reload(), 500);
            } else {
                showAlert('Failed to switch division', 'danger');
            }
        },
        error: function (xhr) {
            hideLoadingOverlay();
            console.error(xhr.responseText);
            showAlert('Error switching division. Please try again.', 'danger');
        }
    });
}


    function showLoadingOverlay(message) {
        let overlay = $('<div id="loading-overlay" style="position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.7);z-index:99999;display:flex;align-items:center;justify-content:center;">' +
            '<div style="background:white;padding:20px 40px;border-radius:8px;text-align:center;">' +
            '<div class="spinner-border text-primary mb-2" role="status"></div>' +
            '<div style="font-size:16px;color:#333;">' + message + '</div>' +
            '</div>' +
            '</div>');
        $('body').append(overlay);
    }

    function hideLoadingOverlay() {
        $('#loading-overlay').remove();
    }

    function showAlert(message, type) {
        let alert = $('<div class="alert alert-' + type + ' alert-dismissible fade show" role="alert" style="position:fixed;top:70px;right:20px;z-index:9999;min-width:300px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">' +
            '<strong>' + message + '</strong>' +
            '<button type="button" class="close" data-dismiss="alert">&times;</button>' +
            '</div>');
        
        $('body').append(alert);
        
        setTimeout(function() {
            alert.fadeOut(function() { 
                $(this).remove(); 
            });
        }, 3000);
    }
</script>

    
    {% block scripts %}{% endblock %}
</body>
</html>
